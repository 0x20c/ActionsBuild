# .github/workflows/emergency-csharp-build.yml
name: ⚡ Emergency C# Builder (V2)

on:
  workflow_dispatch:
    inputs:
      exe_name:
        description: 'Output EXE name (without .exe)'
        required:    true
        default:     'my-program'
      
      csharp_code:
        description: 'Paste your C# code here'
        required:    true
        default: |
          using System;
          public class Program
          {
              public static void Main()
              {
                  Console.WriteLine("Hello from GHA!");
              }
          }

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 步骤 1: 安装 .NET SDK (例如 .NET 6)
      # 这会自动将 `dotnet` CLI 添加到 PATH
      - name: Install .Net SDK
        uses: actions/setup-dotnet@v4
        with:
          # 你可以根据需要更改 .NET 版本
          dotnet-version: 6.0.x

      # 步骤 2: 创建一个临时项目目录
      - name: Create Temporary Project Directory
        shell: pwsh
        run: |
          # 使用 EXE 名称作为项目目录名，方便管理
          $projDir = "${{ inputs.exe_name }}"
          New-Item -ItemType Directory -Path $projDir
          
          # 将项目路径存为 GHA 环境变量，供后续步骤使用
          echo "PROJECT_DIR=$projDir" | Out-File -FilePath $env:GITHUB_ENV -Append

      # 步骤 3: 动态创建最小化的 .csproj 文件
      # 这是让 `dotnet build` 工作的关键
      - name: Create Minimal .csproj File
        shell: pwsh
        run: |
          # 定义 .csproj 文件的内容
          # - OutputType=Exe: 编译为可执行文件
          # - EnableDefaultCompileItems=false: 告诉编译器不要自动包含文件
          #   (我们将在下一步精确指定要编译的文件)
          $csprojContent = @"
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net6.0</TargetFramework>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <AssemblyName>${{ inputs.exe_name }}</AssemblyName>
  </PropertyGroup>
  <ItemGroup>
    <Compile Include="${{ inputs.exe_name }}.cs" />
  </ItemGroup>
</Project>
"@
          # 将内容写入 .csproj 文件
          Set-Content -Path "${{ env.PROJECT_DIR }}/${{ inputs.exe_name }}.csproj" -Value $csprojContent

      # 步骤 4: 将输入的 C# 代码写入 .cs 文件
      - name: Create C# source file from input
        shell: pwsh
        run: |
          $code = @'
          ${{ inputs.csharp_code }}
          '@
          
          # 确保 .cs 文件和 .csproj 文件在同一目录
          Set-Content -Path "${{ env.PROJECT_DIR }}/${{ inputs.exe_name }}.cs" -Value $code
          
          Write-Host "Successfully created ${{ env.PROJECT_DIR }}/${{ inputs.exe_name }}.cs"

      # 步骤 5: 编译 C# 项目
      # 使用 `dotnet build`，它会自动找到 .csproj 和 .cs 文件
      - name: Build the application
        shell: pwsh
        run: |
          # -c Release: 编译为 Release 版本
          dotnet build "${{ env.PROJECT_DIR }}/${{ inputs.exe_name }}.csproj" -c Release

      # 步骤 6: 上传编译结果
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.exe_name }}
          # .exe 文件位于 build 输出目录中
          path: "${{ env.PROJECT_DIR }}/bin/Release/net6.0/${{ inputs.exe_name }}.exe"
          retention-days: 1
